<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- <script src="./js/sessao.js"></script> -->

    <link rel="shortcut icon" type="imagex/png" href="../assets/img/ponyo-icone.png">
    <link rel="stylesheet" type="text/css" href="../css/dashboards.css" media="screen" />
    <title>Mundo Ponyo</title>

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="atualizarPagina()">

    <section id="container">
        <div class="nav_lateral">
            <div class="div_logoMundoPonyo">
                <img id="imgMundoPonyo" src="../assets/img/logo-mundo-ponyo.png" alt="Mundo Ponyo">
            </div>
            <div id="div_bemVindo">Bem vindo de volta!</div>
            <div id="containerLinks">
                <div class="div_links">
                    <div class="link" onclick="ativarDashboard()" id="link_dashboard">
                        <img src="../assets/img/dashboard-icone.png" alt="Dashboard" style="width: 20px;">
                        <div class="textLink">
                            Meu Painel
                        </div>
                    </div>
                    <div class="link" onclick="ativarGaleria()" id="link_galeria">
                        <img src="../assets/img/photo-gallery-icone.png" alt="Galeria" style="width: 20px;">
                        <div class="textLink">
                            Galeria
                        </div>
                    </div>
                    <div class="link" onclick="ativarJogo()" id="link_jogo">
                        <img src="../assets/img/jogo-icone.png" alt="Jogo" style="width: 20px;">
                        <div class="textLink">
                            Jogo
                        </div>
                    </div>
                    <div class="link" onclick="ativarRanking()" id="link_ranking">
                        <img src="../assets/img/trofeu-icone.png" alt="Ranking" style="width: 20px;">
                        <div class="textLink">
                            Ranking
                        </div>
                    </div>
                </div>
            </div>
            <div id="div_sair">
                <div class="conteudo_sair" onclick="sair()">SAIR</div>
            </div>
        </div>

        <!-- CONTEÚDOS DA ÁREA DO USUÁRIO -->
        <!-- Dashboard -->
        <div class="conteudo_dashboard">
            <div class="titulo_conteudo">Meu Painel</div>
            <div class="corpo_dashboard">
                <div class="div_kpis">
                    <div class="kpi">
                        <div class="titulo_kpi">Recorde Atual</div>
                        <div class="dado_kpi" id="kpi_recorde">0 m</div>
                    </div>
                    <div class="kpi">
                        <div class="titulo_kpi">Média de Pontuação por partida</div>
                        <div class="dado_kpi" id="kpi_mediaPontuacao">0 m</div>
                    </div>
                    <div class="kpi">
                        <div class="titulo_kpi">Total de partidas Jogadas</div>
                        <div class="dado_kpi" id="kpi_totalPartidas">0</div>
                    </div>
                    <div class="kpi">
                        <div class="titulo_kpi">Tempo de Jogo Acumulado</div>
                        <div class="dado_kpi">0 min</div>
                    </div>
                    <div class="kpi">
                        <div class="titulo_kpi">Personagem Favorito</div>
                        <div class="dado_kpi">――――</div>
                    </div>
                </div>
                <div class="container_grafico">
                    <div class="div_graficoLinha">
                        <div class="titulo_grafico">Pontuação feita nas últimas partidas</div>
                        <div class="graficoLinha">
                            <!-- <div id="grafico${item.id}" class="display-none"> -->
                            <!-- <h3 class="tituloGraficos">
                                    <span id="tituloAquario${item.id}">${item.descricao}</span>
                                </h3> -->
                            <div class="graph">
                                <canvas id="myChartCanvas"></canvas>
                            </div>
                            <!-- <div class="label-captura">
                                    <p id="avisoCaptura${item.id}" style="color: white"></p>
                                </div> -->
                            <!-- </div> -->
                        </div>
                    </div>
                    <div class="div_graficoPizza">
                        <div class="titulo_graficoPizza">Quantidade de partidas jogadas com cada personagem</div>
                        <div class="graficoPizza"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Galeria -->
        <div class="conteudo_galeria">
            <div class="titulo_padrao">Galeria</div>
            <div class="div_select">
                <select name="slcGaleria" id="slcGaleria" onchange="filtrarGaleria()">
                    <option value="tudo">Mostrar Tudo</option>
                    <option value="fotos">Fotos - Animação</option>
                    <option value="arts">Arts of Ponyo - Hayao Miyazaki</option>
                </select>
            </div>
            <div class="div_fotos">
                <div class="linha_fotos">
                    <a href="../assets/img/ponyo001.jpg"><img src="../assets/img/ponyo001.jpg" alt=""></a>
                    <a href="../assets/img/ponyo002.jpg"><img src="../assets/img/ponyo002.jpg" alt=""></a>
                    <a href="../assets/img/ponyo003.jpg"><img src="../assets/img/ponyo003.jpg" alt=""></a>
                </div>
                <div class="linha_fotos">
                    <a href="../assets/img/ponyo004.jpg"><img src="../assets/img/ponyo004.jpg" alt=""></a>
                    <a href="../assets/img/ponyo005.jpg"><img src="../assets/img/ponyo005.jpg" alt=""></a>
                    <a href="../assets/img/ponyo006.jpg"><img src="../assets/img/ponyo006.jpg" alt=""></a>
                </div>
                <div class="linha_fotos">
                    <a href="../assets/img/ponyo007.jpg"><img src="../assets/img/ponyo007.jpg" alt=""></a>
                    <a href="../assets/img/ponyo008.jpg"><img src="../assets/img/ponyo008.jpg" alt=""></a>
                    <a href="../assets/img/ponyo009.jpg"><img src="../assets/img/ponyo009.jpg" alt=""></a>
                </div>
                <div class="linha_fotos">
                    <a href="../assets/img/ponyo010.jpg"><img src="../assets/img/ponyo010.jpg" alt=""></a>
                    <a href="../assets/img/ponyo011.jpg"><img src="../assets/img/ponyo011.jpg" alt=""></a>
                    <a href="../assets/img/ponyo012.jpg"><img src="../assets/img/ponyo012.jpg" alt=""></a>
                </div>
                <div class="linha_fotos">
                    <a href="../assets/img/ponyo013.jpg"><img src="../assets/img/ponyo013.jpg" alt=""></a>
                    <a href="../assets/img/ponyo014.jpg"><img src="../assets/img/ponyo014.jpg" alt=""></a>
                    <a href="../assets/img/ponyo015.jpg"><img src="../assets/img/ponyo015.jpg" alt=""></a>
                </div>
                <div class="linha_fotos">
                    <a href="../assets/img/ponyo016.jpg"><img src="../assets/img/ponyo016.jpg" alt=""></a>
                    <a href="../assets/img/ponyo017.jpg"><img src="../assets/img/ponyo017.jpg" alt=""></a>
                    <a href="../assets/img/ponyo018.jpg"><img src="../assets/img/ponyo018.jpg" alt=""></a>
                </div>
                <div class="linha_fotos">
                    <a href="../assets/img/ponyo019.jpg"><img src="../assets/img/ponyo019.jpg" alt=""></a>
                    <a href="../assets/img/ponyo020.jpg"><img src="../assets/img/ponyo020.jpg" alt=""></a>
                    <a href="../assets/img/ponyo021.jpg"><img src="../assets/img/ponyo021.jpg" alt=""></a>
                </div>
                <div class="linha_fotos">
                    <a href="../assets/img/ponyo022.jpg"><img src="../assets/img/ponyo022.jpg" alt=""></a>
                    <a href="../assets/img/ponyo023.jpg"><img src="../assets/img/ponyo023.jpg" alt=""></a>
                    <a href="../assets/img/ponyo024.jpg"><img src="../assets/img/ponyo024.jpg" alt=""></a>
                </div>
                <div class="linha_fotos">
                    <a href="../assets/img/ponyo025.jpg"><img src="../assets/img/ponyo025.jpg" alt=""></a>
                    <a href="../assets/img/ponyo026.jpg"><img src="../assets/img/ponyo026.jpg" alt=""></a>
                    <a href="../assets/img/ponyo027.jpg"><img src="../assets/img/ponyo027.jpg" alt=""></a>
                </div>
            </div>

            <div class="div_arts">
                <div class="linha_fotos">
                    <a href="../assets/img/art1.jpg"><img src="../assets/img/art1.jpg" alt=""></a>
                    <a href="../assets/img/art2.jpg"><img src="../assets/img/art2.jpg" alt=""></a>
                    <a href="../assets/img/art3.jpg"><img src="../assets/img/art3.jpg" alt=""></a>
                </div>
                <div class="linha_fotos">
                    <a href="../assets/img/art4.jpg"><img src="../assets/img/art4.jpg" alt=""></a>
                    <a href="../assets/img/art5.jpg"><img src="../assets/img/art5.jpg" alt=""></a>
                    <a href="../assets/img/art6.jpg"><img src="../assets/img/art6.jpg" alt=""></a>
                </div>
                <div class="linha_fotos">
                    <a href="../assets/img/art7.jpg"><img src="../assets/img/art7.jpg" alt=""></a>
                    <a href="../assets/img/art8.jpg"><img src="../assets/img/art8.jpg" alt=""></a>
                    <a href="../assets/img/art9.jpg"><img src="../assets/img/art9.jpg" alt=""></a>
                </div>
                <div class="linha_fotos">
                    <a href="../assets/img/art10.jpg"><img src="../assets/img/art10.jpg" alt=""></a>
                    <a href="../assets/img/art11.jpg"><img src="../assets/img/art11.jpg" alt=""></a>
                    <a href="../assets/img/art12.jpg"><img src="../assets/img/art12.jpg" alt=""></a>
                </div>
                <div class="linha_fotos">
                    <a href="../assets/img/art13.jpg"><img src="../assets/img/art13.jpg" alt=""></a>
                    <a href="../assets/img/art14.jpg"><img src="../assets/img/art14.jpg" alt=""></a>
                    <a href="../assets/img/art15.jpg"><img src="../assets/img/art15.jpg" alt=""></a>
                </div>
                <div class="linha_fotos">
                    <a href="../assets/img/art16.jpg"><img src="../assets/img/art16.jpg" alt=""></a>
                    <a href="../assets/img/art17.jpg"><img src="../assets/img/art17.jpg" alt=""></a>
                    <a href="../assets/img/art18.jpg"><img src="../assets/img/art18.jpg" alt=""></a>
                </div>
            </div>
        </div>

        <!-- Jogo -->
        <div class="conteudo_jogo">
            <div class="titulo_conteudo">Ponyo Run</div>

            <div class="game_board">
                <div id="gradient-cenario-top"></div>
                <div class="div_indicadores_jogo">
                    <div id="div_tempo">
                        <!-- <h1>00:00:00</h1> -->
                    </div>
                    <div id="div_pontuacao">
                        <h1 id="h1_pontuacao">0 m</h1>
                    </div>
                </div>
                <div id="gradient-cenario-bottom"></div>
                <img src="../assets/img/cenario-jogo-ponyo.png" class="cenario">
                <!-- <img src="assets/img/clouds.png" class="clouds"> -->
                <img src="../assets/img/ponyo.gif" class="ponyo">
                <img src="../assets/img/onda1.1.gif" class="obstaculo">
                <div id="div_btIniciar">
                    <button onclick="startGame()" id="start" class="bt_preenchido buttons btIniciar">INICIAR</button>
                </div>
                <div class="game_over">
                    <div id="titulo_gameOver">Game Over</div>
                    <div class="score">
                        <div id="resultado_partida"></div>
                    </div>
                    <div class="recorde">
                        <div id="recorde_usuario">Recorde:</div>
                    </div>
                    <div class="buttons_gameOver">
                        <button onclick="restartGame()" id="restart"
                            class="bt_preenchido buttons btReiniciar">Reiniciar</button>
                        <button onclick="stopGame()" id="stop" class="bt_preenchido buttons btReiniciar">Parar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ranking -->
        <div class="conteudo_ranking">
            <div class="titulo_conteudo">Ranking</div>
        </div>
    </section>
</body>

</html>
<script>
    div_bemVindo.innerHTML = `Olá,&nbsp <b>${sessionStorage.NOME_USUARIO}</b>`;
    var fkUsuario = sessionStorage.getItem("ID_USUARIO");
    let proximaAtualizacao;

    //JOGO
    var pontuacao = 0;
    var indiceVelocidade = 0;
    var tempoDaOnda = 2.5;
    var recordeVar;

    //Selecionando elementos HTML
    const ponyo = document.querySelector('.ponyo');
    const obstaculo = document.querySelector('.obstaculo');
    const start = document.querySelector('#start');
    const gameOver = document.querySelector('.game_over');

    const jump = () => {
        ponyo.classList.add('jump'); //Adiciona a classe 'jump' (ativando a animação de pulo no css)

        setTimeout(() => {
            ponyo.classList.remove('jump'); //Remove a classe após 0.5 segundos (500ms) fazendo a ponyo voltar ao chão
        }, 500);
    }

    const startGame = () => {

        gameOver.style.display = 'none'; //Esconde a tela de game over
        obstaculo.style.display = 'flex'; //Deixa os obstáculos visíveis
        start.style.display = 'none'; //Esconde o botão de iniciar

        const loop = setInterval(() => {

            const obstaculoPosition = obstaculo.offsetLeft; //Pega a posição horizontal do obstáculo
            const ponyoPosition = Number(window.getComputedStyle(ponyo).bottom.replace('px', '')); //Posição vertical da Ponyo

            console.log('onda:' + obstaculoPosition);



            //Verifica a colisão
            if ((obstaculoPosition <= 90 && obstaculoPosition > 0 && ponyoPosition < 85) || (obstaculoPosition < 0 && obstaculoPosition > -50 && ponyoPosition < 43)) {
                recorde_usuario.innerHTML = `Recorde: ${pontuacao.toFixed()} m`

                gameOver.style.display = 'flex'; //Mostra a tela de game over
                resultado_partida.innerHTML = `Pontuação: ${pontuacao.toFixed()} m`;

                //Congela o obstáculo e a Ponyo na posição da colisão
                obstaculo.style.animation = 'none';
                obstaculo.style.left = `${obstaculoPosition}px`;
                ponyo.style.animation = 'none';
                ponyo.style.bottom = `${ponyoPosition}px`;

                //Altera a imagem da Ponyo para game over
                ponyo.src = '../assets/img/ponyo-game-over.png';
                ponyo.style.width = '80px';
                ponyo.style.marginLeft = '30px';

                clearInterval(loop); //Para loop do jogo

                cadastrarPartida().then(function () {
                    recordePonyoRun();
                    mediaPontuacaoPonyoRun(fkUsuario);
                    totalPartidasPonyoRun(fkUsuario);

                    window.addEventListener('load', obterDadosGrafico(fkUsuario))

                    // obterDadoGrafico(fkUsuario);
                });
            } else {
                indiceVelocidade = Number((indiceVelocidade + 0.035).toFixed(2));
                console.log('i: ' + indiceVelocidade);
                console.log('temp onda: ' + tempoDaOnda);
                if (indiceVelocidade > 50.99 && obstaculoPosition < -50 && tempoDaOnda == 2.5) {
                    tempoDaOnda -= 0.3;
                    // // 1. Pausa a animação e congela a posição atual
                    obstaculo.style.animation = 'none';
                    void obstaculo.offsetWidth; // Truque mágico (força a pausa)

                    obstaculo.style.animation = `obstaculo-animation ${tempoDaOnda}s infinite linear`;
                    indiceVelocidade = 0;
                } else if (indiceVelocidade > 50.99 && obstaculoPosition < -50 && tempoDaOnda >= 1.4) {
                    tempoDaOnda -= 0.4;
                    // // 1. Pausa a animação e congela a posição atual
                    obstaculo.style.animation = 'none';
                    void obstaculo.offsetWidth; // Truque mágico (força a pausa)

                    obstaculo.style.animation = `obstaculo-animation ${tempoDaOnda}s infinite linear`;
                    indiceVelocidade = 0;
                }
                pontuacao = pontuacao + 0.035; //Incrementa a pontuacão
                h1_pontuacao.innerHTML = `${pontuacao.toFixed()} m`; //Atualiza ao placar

            }
        }, 10); // 10 miilisegundos = 0.01 segundo
    }

    //Função de reiniciar
    const restartGame = () => {
        gameOver.style.display = 'none'; //Esconde a tela de game over

        //Reseta a Ponyo
        ponyo.classList.remove('jump'); //Remove o estado de pulo pendente
        ponyo.src = '../assets/img/ponyo.gif'; //Volta o gif original
        ponyo.style.width = '7.5%'; //Volta ao tamanho original
        ponyo.style.marginLeft = '0'; //Remove a margin que foi adicionada no momento da colisão
        ponyo.style.bottom = '0px'; //Reinicia a posição vertical
        ponyo.style.animation = ''; //Remove animações travadas

        //Reseta o obstáculo
        obstaculo.style.display = 'flex'; //Garante que está visível
        obstaculo.style.left = ''; //Remove a posição fixa da colisão
        obstaculo.style.animation = 'obstaculo-animation 2.5s infinite linear'; //Reinicia a animação

        //Reseta a pontuação
        pontuacao = 0;
        h1_pontuacao.innerHTML = '0 m';

        indiceVelocidade = 0;
        tempoDaOnda = 2.5;

        //Removendo e readicionando o pulo pra certificar que funcione corretamente
        document.removeEventListener('keydown', jump);
        document.addEventListener('keydown', jump);


        startGame();
    }

    //Sair do jogo
    function stopGame() {
        gameOver.style.display = 'none'; //Esconde a tela de game over
        start.style.display = 'flex'; //Mostra o botão de iniciar

        //Reseta a Ponyo
        ponyo.classList.remove('jump'); //Remove o estado de pulo pendente
        ponyo.src = '../assets/img/ponyo.gif'; //Volta o gif original
        ponyo.style.width = '7.5%'; //Volta ao tamanho original
        ponyo.style.marginLeft = '0'; //Remove a margin que foi adicionada no momento da colisão
        ponyo.style.bottom = '0px'; //Reinicia a posição vertical
        ponyo.style.animation = ''; //Remove animações travadas

        //Reseta o obstáculo
        obstaculo.style.display = 'none';
        obstaculo.style.left = '';
        obstaculo.style.animation = '';

        //Reseta a pontuação
        pontuacao = 0;
        h1_pontuacao.innerHTML = '0 m';

        indiceVelocidade = 0;
        tempoDaOnda = 2.5;

        //Removendo e readicionando o pulo pra certificar que funcione corretamente
        document.removeEventListener('keydown', jump);
        document.addEventListener('keydown', jump);
    }

    //Função de pulo ao clicar em qualquer tela
    document.addEventListener('keydown', jump);


    //Cadastrando partida no banco de dados
    function cadastrarPartida() {
        var fkUsuario = sessionStorage.getItem("ID_USUARIO");
        var pontuacaoVar = Number(pontuacao.toFixed());
        console.log(fkUsuario, pontuacaoVar)

        //O return é necessário nesse fetch para que seja possível utilizar o 
        //.then quando o jogador perde, algo necessário para chamar a função de recorde
        return fetch("/dashboard/cadastrarPartida", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                fkUsuarioServer: fkUsuario,
                pontuacaoServer: pontuacaoVar,
            }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    console.log('Partida cadastrada com sucesso! ✅')
                } else {
                    throw "Houve um erro ao tentar realizar o cadastro!";
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });

        return false;
    }

    //Trazendo KPI - Recorde Atual
    var fkUsuario = sessionStorage.getItem("ID_USUARIO");

    fetch(`/dashboard/buscarRecorde?fkUsuario=${fkUsuario}`, {
        method: "GET",
        headers: {
            "Content-Type": "application/json"
        }
    }).then(function (resposta) {
        console.log("ESTOU NO THEN DO recordePonyoRun()!")
        console.log(resposta);

        if (resposta.ok) {
            resposta.json().then(json => {
                console.log('Dados recebidos', json);
                console.log('Recorde:', json.recorde);
                document.getElementById('recorde_usuario').innerHTML = `Recorde: ${json.recorde} m`;
                document.getElementById('kpi_recorde').innerHTML = `${json.recorde} m`;

                recordeVar = json.recorde;
                console.log('ÓIA', recordeVar)
            });

        } else {
            console.log("Houve um erro ao tentar buscar o recorde!");

            resposta.text().then(texto => {
                console.error(texto);
            });
        }

    }).catch(function (erro) {
        console.log(erro);
    })

    //Trazendo Recorde no Game Over
    function recordePonyoRun() {
        var fkUsuario = sessionStorage.getItem("ID_USUARIO");

        fetch(`/dashboard/buscarRecorde?fkUsuario=${fkUsuario}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO recordePonyoRun()!")
            console.log(resposta);

            if (resposta.ok) {
                resposta.json().then(json => {
                    console.log('Dados recebidos', json);
                    console.log('Recorde:', json.recorde);
                    document.getElementById('recorde_usuario').innerHTML = `Recorde: ${json.recorde} m`;
                    document.getElementById('kpi_recorde').innerHTML = `${json.recorde} m`;

                    recordeVar = json.recorde;
                });

            } else {
                console.log("Houve um erro ao tentar buscar o recorde!");

                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

    }

    //Trazendo KPI - Média de pontuação
    var fkUsuario = sessionStorage.getItem("ID_USUARIO");
    function mediaPontuacaoPonyoRun(fkUsuario) {
        fetch(`/dashboard/buscarMediaPontuacao/${fkUsuario}`, { cache: 'no-store' })
            .then(function (resposta) {
                console.log("ESTOU NO THEN DO mediaPontuacaoPonyoRun()!")
                console.log(resposta);

                if (resposta.ok) {
                    resposta.json().then(json => {
                        console.log('Dados recebidos', json);
                        console.log('Média de Pontuação:', json.media);
                        document.getElementById('kpi_mediaPontuacao').innerHTML = `${json.media} m`;

                    });

                } else {
                    console.log("Houve um erro ao tentar buscar o média!");

                    resposta.text().then(texto => {
                        console.error(texto);
                    });
                }

            }).catch(function (erro) {
                console.log(erro);
            })
    }
    window.addEventListener('load', mediaPontuacaoPonyoRun(fkUsuario))

    //Trazendo KPI - Total de partidas jogadas
    var fkUsuario = sessionStorage.getItem("ID_USUARIO");
    function totalPartidasPonyoRun(fkUsuario) {
        fetch(`/dashboard/buscarTotalPartidas/${fkUsuario}`, { cache: 'no-store' })
            .then(function (resposta) {
                console.log("ESTOU NO THEN DO totalPartidasPonyoRun()!")
                console.log(resposta);

                if (resposta.ok) {
                    resposta.json().then(json => {
                        console.log('Dados recebidos', json);
                        console.log('Total Partidas:', json.total);
                        document.getElementById('kpi_totalPartidas').innerHTML = `${json.total}`;

                    });

                } else {
                    console.log("Houve um erro ao tentar buscar o total de partidas!");
                    resposta.text().then(texto => {
                        console.error(texto);
                    });
                }

            }).catch(function (erro) {
                console.log(erro);
            })
    }
    window.addEventListener('load', totalPartidasPonyoRun(fkUsuario))

    //GRÁFICO DAS ÚLTIMAS PARTIDAS
    function obterDadosGrafico(fkUsuario) {

        // alterarTitulo(fkUsuario)

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        var fkUsuario = sessionStorage.getItem("ID_USUARIO");

        fetch(`/dashboard/ultimas/${fkUsuario}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos - Partidas: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta, fkUsuario);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }
    window.addEventListener('load', obterDadosGrafico(fkUsuario))

    function plotarGrafico(resposta, fkUsuario) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [
                {
                    label: 'Pontuação',
                    data: [],
                    fill: false,
                    borderColor: 'rgb(199, 52, 52)',
                    tension: 0.1
                }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.dtPartida_grafico);
            dados.datasets[0].data.push(registro.pontuacao);
            // dados.datasets[1].data.push(registro.temperatura);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'line',
            data: dados,
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`myChartCanvas`),
            config
        );

        setTimeout(() => atualizarGrafico(fkUsuario, dados, myChart), 2000);
    }

    let activeUpdate = true; // Controle de estado  
    function atualizarGrafico(fkUsuario, dados, myChart) {
        if (!activeUpdate) return; // Não continua se desativado

        var fkUsuario = sessionStorage.getItem("ID_USUARIO");

        fetch(`/dashboard/tempo-real/${fkUsuario}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    // obterdados(fkUsuario);
                    // alertar(novoRegistro, fkUsuario);
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);


                    if (novoRegistro[0].dtPartida_grafico == dados.labels[dados.labels.length - 1]) {
                        // console.log("---------------------------------------------------------------")
                        // console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        // console.log("Horário do novo dado capturado:")
                        // console.log(novoRegistro[0].dtPartida_grafico)
                        // console.log("Horário do último dado capturado:")
                        // console.log(dados.labels[dados.labels.length - 1])
                        // console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro[0].dtPartida_grafico); // incluir um novo dtPartida

                        dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                        dados.datasets[0].data.push(novoRegistro[0].pontuacao); // incluir uma nova medida de umidade

                        myChart.update();
                    }

                    if (activeUpdate) {
                        setTimeout(() => atualizarGrafico(fkUsuario, dados, myChart), 2500);
                    }
                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    // proximaAtualizacao = setTimeout(() => atualizarGrafico(fkUsuario, dados, myChart), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                if (activeUpdate) {
                    setTimeout(() => atualizarGrafico(fkUsuario, dados, myChart), 2500);
                }
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                // proximaAtualizacao = setTimeout(() => atualizarGrafico(fkUsuario, dados, myChart), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }


    function sair() {
        sessionStorage.clear();
        window.location.href = "../index.html"
    }

    function atualizarPagina() {
        var abaAtual = sessionStorage.getItem('LOCAL_USER');

        if (abaAtual === 'dashboardFlex') {
            ativarDashboard();
        } else if (abaAtual === 'galeriaFlex') {
            ativarGaleria();
        } else if (abaAtual === 'jogoFlex') {
            ativarJogo();
        } else if (abaAtual === 'rankingFlex') {
            ativarRanking();
        } else {
            ativarDashboard();
        }
    }

    function ativarDashboard() {
        sessionStorage.setItem('LOCAL_USER', 'dashboardFlex');

        if (sessionStorage.getItem('LOCAL_USER') === 'dashboardFlex' || sessionStorage.getItem('LOCAL_USER') == '') {
            document.getElementsByClassName('conteudo_dashboard')[0].style.display = 'flex';
            document.getElementsByClassName('conteudo_galeria')[0].style.display = 'none';
            document.getElementsByClassName('conteudo_jogo')[0].style.display = 'none';
            document.getElementsByClassName('conteudo_ranking')[0].style.display = 'none';

            document.getElementById('link_dashboard').style.backgroundColor = '#00304a';
            document.getElementById('link_galeria').style.backgroundColor = '';
            document.getElementById('link_jogo').style.backgroundColor = '';
            document.getElementById('link_ranking').style.backgroundColor = '';

        } else if (sessionStorage.getItem('LOCAL_USER') === 'galeriaFlex') {
            ativarGaleria();
        } else if (sessionStorage.getItem('LOCAL_USER') === 'jogoFlex') {
            ativarJogo();
        } else if (sessionStorage.getItem('LOCAL_USER') === 'rankingFlex') {
            ativarRanking();
        }

    }
    function ativarGaleria() {
        document.getElementsByClassName('conteudo_dashboard')[0].style.display = 'none';
        document.getElementsByClassName('conteudo_galeria')[0].style.display = 'flex';
        document.getElementsByClassName('conteudo_jogo')[0].style.display = 'none';
        document.getElementsByClassName('conteudo_ranking')[0].style.display = 'none';

        document.getElementById('link_dashboard').style.backgroundColor = '';
        document.getElementById('link_galeria').style.backgroundColor = '#00304a';
        document.getElementById('link_jogo').style.backgroundColor = '';
        document.getElementById('link_ranking').style.backgroundColor = '';

        sessionStorage.setItem('LOCAL_USER', 'galeriaFlex');
    }
    function ativarJogo() {
        document.getElementsByClassName('conteudo_dashboard')[0].style.display = 'none';
        document.getElementsByClassName('conteudo_galeria')[0].style.display = 'none';
        document.getElementsByClassName('conteudo_jogo')[0].style.display = 'flex';
        document.getElementsByClassName('conteudo_ranking')[0].style.display = 'none';

        document.getElementById('link_dashboard').style.backgroundColor = '';
        document.getElementById('link_galeria').style.backgroundColor = '';
        document.getElementById('link_jogo').style.backgroundColor = '#00304a';
        document.getElementById('link_ranking').style.backgroundColor = '';

        sessionStorage.setItem('LOCAL_USER', 'jogoFlex');
    }
    function ativarRanking() {
        document.getElementsByClassName('conteudo_dashboard')[0].style.display = 'none';
        document.getElementsByClassName('conteudo_galeria')[0].style.display = 'none';
        document.getElementsByClassName('conteudo_jogo')[0].style.display = 'none';
        document.getElementsByClassName('conteudo_ranking')[0].style.display = 'flex';

        document.getElementById('link_dashboard').style.backgroundColor = '';
        document.getElementById('link_galeria').style.backgroundColor = '';
        document.getElementById('link_jogo').style.backgroundColor = '';
        document.getElementById('link_ranking').style.backgroundColor = '#00304a';

        sessionStorage.setItem('LOCAL_USER', 'rankingFlex');
    }

    //FILTRO - GALERIA
    function filtrarGaleria() {
        if (slcGaleria.value == 'tudo') {
            document.getElementsByClassName('div_fotos')[0].style.display = 'block';
            document.getElementsByClassName('div_arts')[0].style.display = 'block';
        } else if (slcGaleria.value == 'fotos') {
            document.getElementsByClassName('div_fotos')[0].style.display = 'block';
            document.getElementsByClassName('div_arts')[0].style.display = 'none';
        } else if (slcGaleria.value == 'arts') {
            document.getElementsByClassName('div_fotos')[0].style.display = 'none';
            document.getElementsByClassName('div_arts')[0].style.display = 'block';
        }
    }

</script>